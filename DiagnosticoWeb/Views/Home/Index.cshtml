@{
    ViewData["Title"] = "Indicadores";
}
@using DiagnosticoWeb.Code

<style>
    /* Estilos para gráficas profesionales */
    .section-title {
        color: #2c3e50;
        font-weight: 600;
        border-bottom: 2px solid #3498db;
        padding-bottom: 10px;
    }

    .chart-card {
        border: 1px solid #e3e6f0;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fc 100%);
    }

        .chart-card:hover {
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.12);
            transform: translateY(-2px);
        }

    .chart-header {
        background: linear-gradient(135deg, #2f8dcb 0%, #2d89c6 100%);
        color: white;
        border-radius: 10px 10px 0 0 !important;
        padding: 15px 20px;
        border-bottom: none;
    }

    .chart-title {
        font-size: 1rem;
        font-weight: 600;
        margin: 0;
        color: white;
    }

    .chart-subtitle {
        font-size: 0.75rem;
        opacity: 0.9;
        color: #ecf0f1;
    }

    /* Gráficas más grandes */
    .chart-container {
        height: 250px;
        min-height: 250px;
        padding: 5px;
    }

    /* Leyenda debajo de cada gráfica */
    .chart-legend {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin: 10px 0;
        padding: 8px;
        background: #f8f9fa;
        border-radius: 6px;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .legend-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
    }

        .legend-dot.no-carencia {
            background: #92dbb1;
        }

        .legend-dot.con-carencia {
            background: #e69188;
        }

    .legend-text {
        font-size: 0.8rem;
        color: #495057;
        font-weight: 500;
    }

    .chart-stats {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 12px;
        margin-top: 8px;
        border: 1px solid #e9ecef;
    }

    .stat-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 6px;
        font-size: 0.8rem;
    }

        .stat-item:last-child {
            margin-bottom: 0;
        }

    .stat-label {
        color: #6c757d;
        font-weight: 500;
    }

    .stat-value {
        font-weight: 600;
        color: #2c3e50;
    }

    /* Responsive design mejorado */
    @@media (max-width: 1200px) {
        .chart-container {
            height: 230px;
            min-height: 230px;
        }
    }

    @@media (max-width: 768px) {
        .chart-container {
            height: 200px;
            min-height: 200px;
        }

        .chart-legend {
            flex-direction: column;
            gap: 8px;
        }
    }

    @@media (max-width: 576px) {
        .chart-container {
            height: 180px;
            min-height: 180px;
        }

        .chart-card {
            margin-bottom: 20px;
        }
    }

    /* Mejoras visuales adicionales */
    .card-body {
        padding: 15px;
    }

    /* Indicadores horizontales estilo profesional */
    .indicador-horizontal {
        display: flex;
        align-items: center;
        padding: 15px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 10px;
        border: 1px solid #dee2e6;
        transition: all 0.3s ease;
        height: 100%;
    }

        .indicador-horizontal:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        }

    .indicador-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        flex-shrink: 0;
    }

        .indicador-icon i {
            color: white;
        }

    .indicador-content {
        flex: 1;
    }

    .indicador-value {
        font-size: 2.2rem;
        font-weight: 700;
        color: #2c3e50;
        line-height: 1;
        margin-bottom: 5px;
    }

    .indicador-label {
        font-size: 0.9rem;
        font-weight: 600;
        color: #3498db;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .indicador-subtext {
        font-size: 0.75rem;
        color: #6c757d;
        margin-top: 2px;
    }

    /* Barra de progreso */
    .progress-container {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #e9ecef;
    }

    .progress-label {
        font-size: 0.9rem;
        font-weight: 600;
        color: #495057;
        margin-bottom: 8px;
    }

    .progress {
        height: 12px;
        border-radius: 6px;
        background-color: #e9ecef;
        overflow: hidden;
    }

    .progress-bar {
        background: linear-gradient(90deg, #3498db 0%, #2980b9 100%);
        border-radius: 6px;
    }

    .progress-text {
        font-size: 0.8rem;
        color: #6c757d;
        text-align: center;
        margin-top: 8px;
        font-weight: 500;
    }

    /* Responsive */
    @@media (max-width: 768px) {
        .indicador-horizontal {
            flex-direction: column;
            text-align: center;
            padding: 20px 15px;
        }

        .indicador-icon {
            margin-right: 0;
            margin-bottom: 10px;
        }

        .indicador-value {
            font-size: 1.8rem;
        }

        .indicador-label {
            font-size: 0.8rem;
        }
    }

    /* Efectos de animación */
    @@keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .indicador-horizontal {
        animation: fadeInUp 0.6s ease-out;
    }

        .indicador-horizontal:nth-child(1) {
            animation-delay: 0.1s;
        }

        .indicador-horizontal:nth-child(2) {
            animation-delay: 0.2s;
        }

        .indicador-horizontal:nth-child(3) {
            animation-delay: 0.3s;
        }

        .indicador-horizontal:nth-child(4) {
            animation-delay: 0.4s;
        }

    svg:not(:root).svg-inline--fa {
        overflow: visible;
        color: aliceblue !important;
    }

    /* Estilos para filtros modernos e institucionales */
    .filtros-container {
        background: linear-gradient(135deg, #f8f9fc 0%, #e9ecef 100%);
        border-radius: 12px;
        padding: 20px;
        border: 1px solid #dee2e6;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        margin-bottom: 20px;
    }

    .filtro-title {
        color: #2c3e50;
        font-weight: 600;
        margin-bottom: 15px;
        border-bottom: 2px solid #3498db;
        padding-bottom: 8px;
        font-size: 1.2rem;
    }

    .filtro-group {
        margin-bottom: 15px;
    }

    .filtro-label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 5px;
        font-size: 0.9rem;
    }

    .filtro-control {
        border-radius: 6px;
        border: 1px solid #ced4da;
        padding: 8px 12px;
        transition: all 0.3s ease;
    }

        .filtro-control:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
        }

    .btn-filtro {
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        border: none;
        border-radius: 6px;
        padding: 10px 20px;
        font-weight: 600;
        color: white;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        width: 100%;
        height: 100%;
        min-height: 42px;
    }

        .btn-filtro:hover {
            background: linear-gradient(135deg, #2980b9 0%, #2471a3 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            color: #cffbfb;
        }

        .btn-filtro:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

    .periodo-container {
        background: #eceff2;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        border: 1px solid #bbdefb;
    }

    .periodo-title {
        color: #1565c0;
        font-weight: 600;
        margin-bottom: 10px;
        font-size: 1rem;
    }

    .al {
        margin: 0 10px;
        line-height: 38px;
        color: #6c757d;
        font-weight: 500;
    }

    /* Responsive para filtros */
    @@media (max-width: 768px) {
        .filtros-container {
            padding: 15px;
        }

        .al {
            margin: 5px 0;
            line-height: normal;
            text-align: center;
        }
    }

    /* Estilos para selects deshabilitados */
    .filtro-control:disabled {
        background-color: #f8f9fa;
        color: #6c757d;
        cursor: not-allowed;
        opacity: 0.7;
    }
</style>

<div ng-app="SedeshuApp" ng-controller="welcomeController" ng-init="init(@JsonSedeshu.SerializeObject(Model))">
    <partial name="_Loading_Partial" />
    <slot ng-cloak>
        <div class="container">
            <div class="card border-cards">
                <div class="card-header bg-cards text-white">
                    <i class="fa fa-chart-line"></i> Indicadores
                </div>

                <div class="card-body">
                    <!-- Sección de Filtros Mejorada -->
                    <div class="filtros-container">
                        <h5 class="filtro-title"><i class="fa fa-filter me-2"></i>Filtros de Búsqueda</h5>

                        <!-- Periodo de Captura en Horizontal -->
                        <div class="periodo-container">
                            <div class="periodo-title">
                                <i class="fa fa-calendar me-2"></i>Período de Captura
                            </div>
                            <div class="row align-items-center">
                                <div class="col-md-6" style="text-align: center;">
                                    <label class="filtro-label">Fecha Inicio</label>
                                    <input type="date" ng-model="filtros.Inicio" class="form-control filtro-control" />
                                </div>
                                <div class="col-md-6" style="text-align: center;">
                                    <label class="filtro-label">Fecha Fin</label>
                                    <input type="date" ng-model="filtros.Fin" class="form-control filtro-control" />
                                </div>
                            </div>
                        </div>

                        <!-- Filtros en Cascada -->
                        <div class="row">
                            <div class="col-md-3 col-sm-6 filtro-group">
                                <label class="filtro-label">Municipio</label>
                                <select class="form-control filtro-control" ng-model="filtros.MunicipioId"
                                        ng-change="cargarTodoDesdeMunicipio()"
                                        ng-options="municipio.Id as municipio.Nombre for municipio in Municipios">
                                    <option value="">-- Seleccione Municipio --</option>
                                </select>
                            </div>
                            <div class="col-md-3 col-sm-6 filtro-group">
                                <label class="filtro-label">Localidad</label>
                                <select class="form-control filtro-control" ng-model="filtros.LocalidadId"
                                        ng-change="cargarTodoDesdeLocalidad()"
                                        ng-disabled="!filtros.MunicipioId"
                                        ng-options="localidad.Id as localidad.Nombre for localidad in Localidades">
                                    <option value="">-- Seleccione Localidad --</option>
                                </select>
                            </div>
                            <div class="col-md-3 col-sm-6 filtro-group">
                                <label class="filtro-label">Colonia</label>
                                <select class="form-control filtro-control" ng-model="filtros.ColoniaId"
                                        ng-change="cargarCURPs()"
                                        ng-disabled="!filtros.MunicipioId"
                                        ng-options="colonia.Id as colonia.Nombre for colonia in Colonias">
                                    <option value="">-- Seleccione Colonia --</option>
                                </select>
                            </div>
                            <div class="col-md-3 col-sm-6 filtro-group">
                                <label class="filtro-label">CURP</label>
                                <select class="form-control filtro-control" ng-model="filtros.CURP"
                                        ng-disabled="!filtros.MunicipioId"
                                        ng-options="curp as curp for curp in CURPs">
                                    <option value="">-- Seleccione CURP --</option>
                                </select>
                            </div>
                        </div>

                        <!-- Botón Buscar en toda la fila -->
                        <div class="row">
                            <div class="col-12">
                                <div class="filtro-group">
                                    <button class="btn btn-filtro" ng-if="!loading" ng-click="buscar()">
                                        <i class="fa fa-search me-2"></i> Buscar
                                    </button>
                                    <button class="btn btn-filtro" ng-if="loading" disabled>
                                        <i class="fa fa-spinner fa-spin me-2"></i> Buscando...
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Resto del contenido (indicadores principales y gráficas) -->
                    <hr>
                    <div class="row">
                        <div class="col-sm-10" style="display:none">
                            <div id="trabajadoresChart"></div>
                        </div>
                        <!-- Tarjeta de Indicadores Principales -->
                        <div class="col-12">
                            <div class="chart-card card mb-4">
                                <div class="card-header chart-header">
                                    <h6 class="chart-title mb-0">
                                        <i class="fa fa-chart-bar me-2"></i>Indicadores Principales
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row text-center">
                                        <!-- Familia -->
                                        <div class="col-md-3 col-sm-6 mb-3">
                                            <div class="indicador-horizontal">
                                                <div class="indicador-icon">
                                                    <i class="fa fa-home fa-2x"></i>
                                                </div>
                                                <div class="indicador-content">
                                                    <div class="indicador-value big">{{NumDomicilios}}</div>
                                                    <div class="indicador-label">Familias</div>
                                                    <div class="indicador-subtext">Total de Diagnósticos</div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Diagnósticos -->
                                        <div class="col-md-3 col-sm-6 mb-3">
                                            <div class="indicador-horizontal">
                                                <div class="indicador-icon">
                                                    <i class="fa fa-file-medical fa-2x"></i>
                                                </div>
                                                <div class="indicador-content">
                                                    <div class="indicador-value big">{{NumDiagnosticos}}</div>
                                                    <div class="indicador-label">Diagnósticos</div>
                                                    <div class="indicador-subtext">Completos</div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Pendientes -->
                                        <div class="col-md-3 col-sm-6 mb-3">
                                            <div class="indicador-horizontal">
                                                <div class="indicador-icon">
                                                    <i class="fa fa-clock fa-2x"></i>
                                                </div>
                                                <div class="indicador-content">
                                                    <div class="indicador-value big">{{NumPendientes}}</div>
                                                    <div class="indicador-label">Diagnósticos</div>
                                                    <div class="indicador-subtext">Incompletos</div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Promedio -->
                                        <div class="col-md-3 col-sm-6 mb-3">
                                            <div class="indicador-horizontal">
                                                <div class="indicador-icon">
                                                    <i class="fa fa-chart-line fa-2x"></i>
                                                </div>
                                                <div class="indicador-content">
                                                    <div class="indicador-value big">{{PromedioCaptura}}</div>
                                                    <div class="indicador-label">Promedio</div>
                                                    <div class="indicador-subtext">Diagnósticos por día</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Barra de progreso adicional -->
                                    <div class="row mt-3">
                                        <div class="col-12">
                                            <div class="progress-container">
                                                <div class="progress-label">Progreso general</div>
                                                <div class="progress">
                                                    <div class="progress-bar progress-bar-striped progress-bar-animated"
                                                         role="progressbar"
                                                         style="width: {{(NumDiagnosticos / NumDomicilios) * 100}}%"
                                                         aria-valuenow="{{(NumDiagnosticos / NumDomicilios) * 100}}"
                                                         aria-valuemin="0"
                                                         aria-valuemax="100">
                                                        {{((NumDiagnosticos / NumDomicilios) * 100).toFixed(1)}}%
                                                    </div>
                                                </div>
                                                <div class="progress-text">
                                                    <span>{{NumDiagnosticos}} de {{NumDomicilios}} diagnósticos completados</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr>
                    <div class="row">
                        <div class="col-12">
                            <h4 class="section-title mb-4">
                                <i class="fa fa-chart-pie me-2"></i>Indicadores de Carencias Sociales
                            </h4>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Pobreza Extrema -->
                        <div class="col-xl-3 col-lg-4 col-md-6 mb-4">
                            <div class="chart-card card h-100">
                                <div class="card-header chart-header">
                                    <h6 class="chart-title">Pobreza Extrema</h6>
                                    <span class="chart-subtitle">Total: {{carenciasData.pobrezaExtrema.total}} hogares</span>
                                </div>
                                <div class="card-body">
                                    <div id="pobrezaExtremaChart" class="chart-container"></div>
                                    <div class="chart-legend">
                                        <div class="legend-item">
                                            <span class="legend-dot no-carencia"></span>
                                            <span class="legend-text">No pobres extremos</span>
                                        </div>
                                        <div class="legend-item">
                                            <span class="legend-dot con-carencia"></span>
                                            <span class="legend-text">Pobres extremos</span>
                                        </div>
                                    </div>
                                    <div class="chart-stats">
                                        <div class="stat-item">
                                            <span class="stat-label">Sin carencia:</span>
                                            <span class="stat-value">{{carenciasData.pobrezaExtrema.sinCarencia}} ({{carenciasData.pobrezaExtrema.porcentajeSinCarencia}}%)</span>
                                        </div>
                                        <div class="stat-item">
                                            <span class="stat-label">Con carencia:</span>
                                            <span class="stat-value">{{carenciasData.pobrezaExtrema.conCarencia}} ({{carenciasData.pobrezaExtrema.porcentajeConCarencia}}%)</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Rezago Educativo -->
                        <div class="col-xl-3 col-lg-4 col-md-6 mb-4">
                            <div class="chart-card card h-100">
                                <div class="card-header chart-header">
                                    <h6 class="chart-title">Rezago Educativo</h6>
                                    <span class="chart-subtitle">Total: {{carenciasData.rezagoEducativo.total}} hogares</span>
                                </div>
                                <div class="card-body">
                                    <div id="rezagoEducativoChart" class="chart-container"></div>
                                    <div class="chart-legend">
                                        <div class="legend-item">
                                            <span class="legend-dot no-carencia"></span>
                                            <span class="legend-text">Sin rezago</span>
                                        </div>
                                        <div class="legend-item">
                                            <span class="legend-dot con-carencia"></span>
                                            <span class="legend-text">Con rezago</span>
                                        </div>
                                    </div>
                                    <div class="chart-stats">
                                        <div class="stat-item">
                                            <span class="stat-label">Sin carencia:</span>
                                            <span class="stat-value">{{carenciasData.rezagoEducativo.sinCarencia}} ({{carenciasData.rezagoEducativo.porcentajeSinCarencia}}%)</span>
                                        </div>
                                        <div class="stat-item">
                                            <span class="stat-label">Con carencia:</span>
                                            <span class="stat-value">{{carenciasData.rezagoEducativo.conCarencia}} ({{carenciasData.rezagoEducativo.porcentajeConCarencia}}%)</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Servicios de Salud -->
                        <div class="col-xl-3 col-lg-4 col-md-6 mb-4">
                            <div class="chart-card card h-100">
                                <div class="card-header chart-header">
                                    <h6 class="chart-title">Acceso a Servicios de Salud</h6>
                                    <span class="chart-subtitle">Total: {{carenciasData.salud.total}} hogares</span>
                                </div>
                                <div class="card-body">
                                    <div id="saludChart" class="chart-container"></div>
                                    <div class="chart-legend">
                                        <div class="legend-item">
                                            <span class="legend-dot no-carencia"></span>
                                            <span class="legend-text">Sin carencia</span>
                                        </div>
                                        <div class="legend-item">
                                            <span class="legend-dot con-carencia"></span>
                                            <span class="legend-text">Con carencia</span>
                                        </div>
                                    </div>
                                    <div class="chart-stats">
                                        <div class="stat-item">
                                            <span class="stat-label">Sin carencia:</span>
                                            <span class="stat-value">{{carenciasData.salud.sinCarencia}} ({{carenciasData.salud.porcentajeSinCarencia}}%)</span>
                                        </div>
                                        <div class="stat-item">
                                            <span class="stat-label">Con carencia:</span>
                                            <span class="stat-value">{{carenciasData.salud.conCarencia}} ({{carenciasData.salud.porcentajeConCarencia}}%)</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Seguridad Social -->
                        <div class="col-xl-3 col-lg-4 col-md-6 mb-4">
                            <div class="chart-card card h-100">
                                <div class="card-header chart-header">
                                    <h6 class="chart-title">Acceso a Seguridad Social</h6>
                                    <span class="chart-subtitle">Total: {{carenciasData.seguridadSocial.total}} hogares</span>
                                </div>
                                <div class="card-body">
                                    <div id="seguridadSocialChart" class="chart-container"></div>
                                    <div class="chart-legend">
                                        <div class="legend-item">
                                            <span class="legend-dot no-carencia"></span>
                                            <span class="legend-text">Sin carencia</span>
                                        </div>
                                        <div class="legend-item">
                                            <span class="legend-dot con-carencia"></span>
                                            <span class="legend-text">Con carencia</span>
                                        </div>
                                    </div>
                                    <div class="chart-stats">
                                        <div class="stat-item">
                                            <span class="stat-label">Sin carencia:</span>
                                            <span class="stat-value">{{carenciasData.seguridadSocial.sinCarencia}} ({{carenciasData.seguridadSocial.porcentajeSinCarencia}}%)</span>
                                        </div>
                                        <div class="stat-item">
                                            <span class="stat-label">Con carencia:</span>
                                            <span class="stat-value">{{carenciasData.seguridadSocial.conCarencia}} ({{carenciasData.seguridadSocial.porcentajeConCarencia}}%)</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Calidad de Vivienda -->
                        <div class="col-xl-3 col-lg-4 col-md-6 mb-4">
                            <div class="chart-card card h-100">
                                <div class="card-header chart-header">
                                    <h6 class="chart-title">Calidad y Espacios de Vivienda</h6>
                                    <span class="chart-subtitle">Total: {{carenciasData.calidadVivienda.total}} hogares</span>
                                </div>
                                <div class="card-body">
                                    <div id="calidadViviendaChart" class="chart-container"></div>
                                    <div class="chart-legend">
                                        <div class="legend-item">
                                            <span class="legend-dot no-carencia"></span>
                                            <span class="legend-text">Sin carencia</span>
                                        </div>
                                        <div class="legend-item">
                                            <span class="legend-dot con-carencia"></span>
                                            <span class="legend-text">Con carencia</span>
                                        </div>
                                    </div>
                                    <div class="chart-stats">
                                        <div class="stat-item">
                                            <span class="stat-label">Sin carencia:</span>
                                            <span class="stat-value">{{carenciasData.calidadVivienda.sinCarencia}} ({{carenciasData.calidadVivienda.porcentajeSinCarencia}}%)</span>
                                        </div>
                                        <div class="stat-item">
                                            <span class="stat-label">Con carencia:</span>
                                            <span class="stat-value">{{carenciasData.calidadVivienda.conCarencia}} ({{carenciasData.calidadVivienda.porcentajeConCarencia}}%)</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Servicios Básicos -->
                        <div class="col-xl-3 col-lg-4 col-md-6 mb-4">
                            <div class="chart-card card h-100">
                                <div class="card-header chart-header">
                                    <h6 class="chart-title">Servicios Básicos en Vivienda</h6>
                                    <span class="chart-subtitle">Total: {{carenciasData.serviciosBasicos.total}} hogares</span>
                                </div>
                                <div class="card-body">
                                    <div id="serviciosBasicosChart" class="chart-container"></div>
                                    <div class="chart-legend">
                                        <div class="legend-item">
                                            <span class="legend-dot no-carencia"></span>
                                            <span class="legend-text">Sin carencia</span>
                                        </div>
                                        <div class="legend-item">
                                            <span class="legend-dot con-carencia"></span>
                                            <span class="legend-text">Con carencia</span>
                                        </div>
                                    </div>
                                    <div class="chart-stats">
                                        <div class="stat-item">
                                            <span class="stat-label">Sin carencia:</span>
                                            <span class="stat-value">{{carenciasData.serviciosBasicos.sinCarencia}} ({{carenciasData.serviciosBasicos.porcentajeSinCarencia}}%)</span>
                                        </div>
                                        <div class="stat-item">
                                            <span class="stat-label">Con carencia:</span>
                                            <span class="stat-value">{{carenciasData.serviciosBasicos.conCarencia}} ({{carenciasData.serviciosBasicos.porcentajeConCarencia}}%)</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Alimentación -->
                        <div class="col-xl-3 col-lg-4 col-md-6 mb-4">
                            <div class="chart-card card h-100">
                                <div class="card-header chart-header">
                                    <h6 class="chart-title">Acceso a Alimentación Nutritiva</h6>
                                    <span class="chart-subtitle">Total: {{carenciasData.alimentacion.total}} hogares</span>
                                </div>
                                <div class="card-body">
                                    <div id="alimentacionChart" class="chart-container"></div>
                                    <div class="chart-legend">
                                        <div class="legend-item">
                                            <span class="legend-dot no-carencia"></span>
                                            <span class="legend-text">Sin carencia</span>
                                        </div>
                                        <div class="legend-item">
                                            <span class="legend-dot con-carencia"></span>
                                            <span class="legend-text">Con carencia</span>
                                        </div>
                                    </div>
                                    <div class="chart-stats">
                                        <div class="stat-item">
                                            <span class="stat-label">Sin carencia:</span>
                                            <span class="stat-value">{{carenciasData.alimentacion.sinCarencia}} ({{carenciasData.alimentacion.porcentajeSinCarencia}}%)</span>
                                        </div>
                                        <div class="stat-item">
                                            <span class="stat-label">Con carencia:</span>
                                            <span class="stat-value">{{carenciasData.alimentacion.conCarencia}} ({{carenciasData.alimentacion.porcentajeConCarencia}}%)</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Resumen General de Carencias -->
                        <div class="col-xl-3 col-lg-4 col-md-6 mb-4">
                            <div class="chart-card card h-100">
                                <div class="card-header chart-header">
                                    <h6 class="chart-title">Resumen General de Carencias</h6>
                                    <span class="chart-subtitle">Porcentaje de hogares con carencias</span>
                                </div>
                                <div class="card-body">
                                    <div id="resumenCarenciasChart" class="chart-container"></div>
                                    <div class="chart-stats">
                                        <div class="stat-item">
                                            <span class="stat-label">Total hogares analizados:</span>
                                            <span class="stat-value">{{carenciasData.resumen.totalHogares}}</span>
                                        </div>
                                        <div class="stat-item">
                                            <span class="stat-label">Hogares con al menos 1 carencia:</span>
                                            <span class="stat-value">{{carenciasData.resumen.conCarencia}} ({{carenciasData.resumen.porcentajeConCarencia}}%)</span>
                                        </div>
                                        <div class="stat-item">
                                            <span class="stat-label">Hogares sin carencias:</span>
                                            <span class="stat-value">{{carenciasData.resumen.sinCarencia}} ({{carenciasData.resumen.porcentajeSinCarencia}}%)</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </slot>
</div>

@section Scripts {
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script>
        (function () {
            var app = angular.module('SedeshuApp', ['ui.bootstrap']);
            var baseUrl = document.baseURI;

            app.controller('welcomeController',
                function ($scope) {
                    $scope.loading = false;
                    $scope.initializing = false;
                    $scope.Municipios = [];
                    $scope.Localidades = [];
                    $scope.Colonias = [];
                    $scope.CURPs = [];
                    $scope.NumDomicilios = 0;
                    $scope.NumDiagnosticos = 0;
                    $scope.NumPendientes = 0;
                    $scope.PromedioCaptura = 0;
                    $scope.carenciasData = {};

                    $scope.filtros = {
                        Inicio: "",
                        Fin: "",
                        MunicipioId: "",
                        LocalidadId: "",
                        ColoniaId: "",
                        CURP: ""
                    };

                    $scope.init = function (model) {
                        console.log('Init ejecutado con modelo:', model);

                        $scope.filtros.Inicio = new Date(model.Inicio.substring(0, 4), parseInt(model.Inicio.substring(5, 7)) - 1, model.Inicio.substring(8, 10));
                        $scope.filtros.Fin = new Date(model.Fin.substring(0, 4), parseInt(model.Fin.substring(5, 7)) - 1, model.Fin.substring(8, 10));

                        $scope.initializing = true;
                        $scope.Municipios = model.MunicipiosFiltro;
                        $scope.NumDomiciliosSinCalculo = model.NumDomiciliosSinCalculo;

                        console.log('Filtros inicializados:', $scope.filtros);

                        // Forzar la actualización con timeout
                        setTimeout(function() {
                            $scope.$apply(function() {
                                $scope.buscar();
                            });
                        }, 100);
                    };

                    // Función para cargar localidades basadas en el municipio seleccionado
                    $scope.cargarLocalidades = function () {
                        if (!$scope.filtros.MunicipioId) {
                            $scope.Localidades = [];
                            $scope.filtros.LocalidadId = "";
                            $scope.filtros.ColoniaId = "";
                            $scope.filtros.CURP = "";
                            $scope.Colonias = [];
                            $scope.CURPs = [];
                            return;
                        }

                        $scope.loading = true;
                        // Enviar todos los filtros actuales para que el servidor los aplique
                        axios.post(baseUrl + 'Home/CargarLocalidades', $scope.filtros)
                            .then(function (response) {
                                $scope.Localidades = response.data.map(function(item) {
                                    return {
                                        Id: item.Id || item.id || item.value || item.Value,
                                        Nombre: item.Nombre || item.nombre || item.text || item.Text || item.name || item.Name
                                    };
                                });

                                // Limpiar filtros dependientes pero mantener la opción "-- Seleccione --"
                                $scope.filtros.LocalidadId = "";
                                $scope.filtros.ColoniaId = "";
                                $scope.filtros.CURP = "";
                                $scope.Colonias = [];
                                $scope.CURPs = [];
                                
                                $scope.loading = false;
                                $scope.$apply();
                            })
                            .catch(function (error) {
                                console.error('Error al cargar localidades:', error);
                                $scope.Localidades = [];
                                $scope.Colonias = [];
                                $scope.CURPs = [];
                                $scope.loading = false;
                                $scope.$apply();
                            });
                    };

                    // Función para cargar colonias basadas en la localidad seleccionada
                    $scope.cargarColonias = function () {
                        if (!$scope.filtros.MunicipioId) {
                            $scope.Colonias = [];
                            $scope.filtros.ColoniaId = "";
                            $scope.filtros.CURP = "";
                            $scope.CURPs = [];
                            return;
                        }

                        $scope.loading = true;
                        // Enviar todos los filtros actuales para que el servidor los aplique
                        axios.post(baseUrl + 'Home/CargarColonias', $scope.filtros)
                            .then(function (response) {
                                $scope.Colonias = response.data.map(function(item) {
                                    return {
                                        Id: item.Id || item.id || item.value || item.Value,
                                        Nombre: item.Nombre || item.nombre || item.text || item.Text || item.name || item.Name
                                    };
                                });

                                // Limpiar CURP pero mantener la opción "-- Seleccione --"
                                $scope.filtros.ColoniaId = "";
                                $scope.filtros.CURP = "";
                                $scope.CURPs = [];
                                
                                $scope.loading = false;
                                $scope.$apply();
                            })
                            .catch(function (error) {
                                console.error('Error al cargar colonias:', error);
                                $scope.Colonias = [];
                                $scope.CURPs = [];
                                $scope.loading = false;
                                $scope.$apply();
                            });
                    };

                    // Función para cargar CURPs basadas en la localidad seleccionada
                    $scope.cargarCURPs = function () {
                        // Permitir cargar CURPs si hay MunicipioId seleccionado
                        if (!$scope.filtros.MunicipioId) {
                            $scope.CURPs = [];
                            $scope.filtros.CURP = "";
                            return;
                        }

                        $scope.loading = true;
                        // Enviar todos los filtros actuales para que el servidor los aplique
                        axios.post(baseUrl + 'Home/CargarCURPs', $scope.filtros)
                            .then(function (response) {
                                $scope.CURPs = response.data;
                                $scope.filtros.CURP = "";
                                $scope.loading = false;
                                $scope.$apply();
                            })
                            .catch(function (error) {
                                console.error('Error al cargar CURPs:', error);
                                $scope.CURPs = [];
                                $scope.loading = false;
                                $scope.$apply();
                            });
                    };

                    // Función para cargar todo cuando se selecciona localidad
                    $scope.cargarTodoDesdeLocalidad = function() {
                        console.log('cargarTodoDesdeLocalidad ejecutado - LocalidadId:', $scope.filtros.LocalidadId);
    
                        // SIEMPRE limpia los filtros dependientes
                        $scope.filtros.ColoniaId = "";
                        $scope.filtros.CURP = "";
    
                        // SIEMPRE carga colonias y CURPs, sin importar si hay LocalidadId o no
                        $scope.cargarColonias();
    
                        // Luego cargar CURPs (se ejecutará después de cargar colonias)
                        setTimeout(function() {
                            $scope.cargarCURPs();
                        }, 500);
                    };

                    // Función para cargar todo automáticamente cuando se selecciona un municipio
                    $scope.cargarTodoDesdeMunicipio = function() {
                        if (!$scope.filtros.MunicipioId) {
                            $scope.Localidades = [];
                            $scope.Colonias = [];
                            $scope.CURPs = [];
                            $scope.filtros.LocalidadId = "";
                            $scope.filtros.ColoniaId = "";
                            $scope.filtros.CURP = "";
                            return;
                        }

                        // Cargar localidades primero
                        $scope.cargarLocalidades();

                        // Luego cargar colonias y CURPs automáticamente
                        setTimeout(function() {
                            if ($scope.Localidades.length > 0) {
                                // NO seleccionar automáticamente la primera localidad
                                // Dejar que el usuario elija manualmente
                                $scope.cargarColonias();
                                
                                // Cargar CURPs después de un breve delay
                                setTimeout(function() {
                                    $scope.cargarCURPs();
                                }, 800);
                            }
                        }, 600);
                    };

                    $scope.buscar = function () {
                        $scope.loading = true;
                        $scope.Total = 0;

                        axios.post(baseUrl + 'Home/Buscar', $scope.filtros).then(function (response) {
                            $scope.NumDomicilios = response.data.NumDomicilios;
                            $scope.NumDiagnosticos = response.data.NumDiagnosticos;
                            $scope.NumPendientes = response.data.NumPendientes;
                            $scope.PromedioCaptura = response.data.PromedioCaptura;

                            // Obtener datos de carencias del controlador
                            axios.post(baseUrl + 'Home/ObtenerCarencias', $scope.filtros).then(function (carenciasResponse) {
                                $scope.carenciasData = carenciasResponse.data;

                                // Cargar todos los paquetes necesarios
                                google.charts.load('current', {
                                    packages: ['corechart', 'bar']
                                });

                                function drawChart() {
                                    // Configuración profesional para gráficas de pastel
                                    var professionalOptions = {
                                        title: '',
                                        titleTextStyle: {
                                            fontSize: 14,
                                            bold: true,
                                            color: '#2c3e50'
                                        },
                                        legend: {
                                            position: 'none'
                                        },
                                        pieSliceText: 'percentage',
                                        pieSliceTextStyle: {
                                            color: '#638898',
                                            fontSize: 12,
                                            bold: true
                                        },
                                        chartArea: {
                                            left: 5,
                                            top: 5,
                                            width: '95%',
                                            height: '85%'
                                        },
                                        tooltip: {
                                            text: 'both',
                                            textStyle: {
                                                fontSize: 12
                                            },
                                            showColorCode: true
                                        },
                                        slices: {
                                            0: {
                                                color: '#92dbb1',
                                                offset: 0.02
                                            },
                                            1: {
                                                color: '#e69188',
                                                offset: 0.01
                                            }
                                        },
                                        backgroundColor: 'transparent',
                                        is3D: false,
                                        pieHole: 0.35,
                                        pieStartAngle: 0,
                                        sliceVisibilityThreshold: 0
                                    };

                                    // 1. Pobreza extrema
                                    var pobrezaExtremaData = google.visualization.arrayToDataTable([
                                        ['Estado', 'Hogares'],
                                        ['No pobres extremos', $scope.carenciasData.pobrezaExtrema.sinCarencia],
                                        ['Pobres extremos', $scope.carenciasData.pobrezaExtrema.conCarencia]
                                    ]);
                                    var pobrezaExtremaChart = new google.visualization.PieChart(document.getElementById('pobrezaExtremaChart'));
                                    pobrezaExtremaChart.draw(pobrezaExtremaData, professionalOptions);

                                    // 2. Rezago educativo
                                    var rezagoEducativoData = google.visualization.arrayToDataTable([
                                        ['Estado', 'Hogares'],
                                        ['Sin rezago', $scope.carenciasData.rezagoEducativo.sinCarencia],
                                        ['Con rezago', $scope.carenciasData.rezagoEducativo.conCarencia]
                                    ]);
                                    var rezagoEducativoChart = new google.visualization.PieChart(document.getElementById('rezagoEducativoChart'));
                                    rezagoEducativoChart.draw(rezagoEducativoData, professionalOptions);

                                    // 3. Carencia por acceso a servicios de salud
                                    var saludData = google.visualization.arrayToDataTable([
                                        ['Estado', 'Hogares'],
                                        ['Sin carencia', $scope.carenciasData.salud.sinCarencia],
                                        ['Con carencia', $scope.carenciasData.salud.conCarencia]
                                    ]);
                                    var saludChart = new google.visualization.PieChart(document.getElementById('saludChart'));
                                    saludChart.draw(saludData, professionalOptions);

                                    // 4. Carencia por acceso a seguridad social
                                    var seguridadSocialData = google.visualization.arrayToDataTable([
                                        ['Estado', 'Hogares'],
                                        ['Sin carencia', $scope.carenciasData.seguridadSocial.sinCarencia],
                                        ['Con carencia', $scope.carenciasData.seguridadSocial.conCarencia]
                                    ]);
                                    var seguridadSocialChart = new google.visualization.PieChart(document.getElementById('seguridadSocialChart'));
                                    seguridadSocialChart.draw(seguridadSocialData, professionalOptions);

                                    // 5. Carencia por calidad y espacios de la vivienda
                                    var calidadViviendaData = google.visualization.arrayToDataTable([
                                        ['Estado', 'Hogares'],
                                        ['Sin carencia', $scope.carenciasData.calidadVivienda.sinCarencia],
                                        ['Con carencia', $scope.carenciasData.calidadVivienda.conCarencia]
                                    ]);
                                    var calidadViviendaChart = new google.visualization.PieChart(document.getElementById('calidadViviendaChart'));
                                    calidadViviendaChart.draw(calidadViviendaData, professionalOptions);

                                    // 6. Carencia por servicios básicos en la vivienda
                                    var serviciosBasicosData = google.visualization.arrayToDataTable([
                                        ['Estado', 'Hogares'],
                                        ['Sin carencia', $scope.carenciasData.serviciosBasicos.sinCarencia],
                                        ['Con carencia', $scope.carenciasData.serviciosBasicos.conCarencia]
                                    ]);
                                    var serviciosBasicosChart = new google.visualization.PieChart(document.getElementById('serviciosBasicosChart'));
                                    serviciosBasicosChart.draw(serviciosBasicosData, professionalOptions);

                                    // 7. Carencia por acceso a alimentación nutritiva
                                    var alimentacionData = google.visualization.arrayToDataTable([
                                        ['Estado', 'Hogares'],
                                        ['Sin carencia', $scope.carenciasData.alimentacion.sinCarencia],
                                        ['Con carencia', $scope.carenciasData.alimentacion.conCarencia]
                                    ]);
                                    var alimentacionChart = new google.visualization.PieChart(document.getElementById('alimentacionChart'));
                                    alimentacionChart.draw(alimentacionData, professionalOptions);

                                    // 8. Resumen General de Carencias (Gráfica de barras)
                                    var resumenData = google.visualization.arrayToDataTable([
                                        ['Carencia', 'Porcentaje'],
                                        ['Seguridad Social', $scope.carenciasData.seguridadSocial.porcentajeConCarencia],
                                        ['Servicios de Salud', $scope.carenciasData.salud.porcentajeConCarencia],
                                        ['Rezago Educativo', $scope.carenciasData.rezagoEducativo.porcentajeConCarencia],
                                        ['Alimentación', $scope.carenciasData.alimentacion.porcentajeConCarencia],
                                        ['Servicios Básicos', $scope.carenciasData.serviciosBasicos.porcentajeConCarencia],
                                        ['Calidad Vivienda', $scope.carenciasData.calidadVivienda.porcentajeConCarencia],
                                        ['Pobreza Extrema', $scope.carenciasData.pobrezaExtrema.porcentajeConCarencia]
                                    ]);

                                    var resumenOptions = {
                                        title: '',
                                        chartArea: {
                                            left: 120,
                                            top: 20,
                                            width: '80%',
                                            height: '80%'
                                        },
                                        hAxis: {
                                            title: 'Porcentaje (%)',
                                            minValue: 0,
                                            maxValue: 50,
                                            format: '#\'%\'',
                                            gridlines: { count: 5 },
                                            textStyle: { fontSize: 11 }
                                        },
                                        vAxis: {
                                            textStyle: { fontSize: 11 }
                                        },
                                        legend: { position: 'none' },
                                        bars: 'horizontal',
                                        colors: ['#3498db'],
                                        backgroundColor: 'transparent',
                                        tooltip: { textStyle: { fontSize: 12 }, showColorCode: true }
                                    };

                                    var resumenChart = new google.visualization.BarChart(document.getElementById('resumenCarenciasChart'));
                                    resumenChart.draw(resumenData, resumenOptions);

                                    $scope.finished();
                                }

                                google.charts.setOnLoadCallback(drawChart);
                            });
                        });
                    };

                    $scope.finished = function () {
                        setTimeout(function () {
                            $scope.$apply(function () {
                                $scope.loading = false;
                                $scope.initializing = false;
                            });
                        });
                    };
                }
            );
        })();
    </script>
}

@section Styles
{
    <style>
        .indicador {
            padding: 5px;
            margin: 5px;
            border: 1px solid #4e555b;
        }

        #solicitudesChart {
            height: 420px;
        }

        .big {
            font-size: 2.5em;
        }
    </style>
}