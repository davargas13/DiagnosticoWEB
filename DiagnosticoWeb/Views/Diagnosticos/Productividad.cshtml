@using DiagnosticoWeb.Code
@{
    ViewData["Title"] = "Productividad";
}
@using System.Security.Claims;
<div ng-app="SedeshuApp" ng-controller="indexController" ng-init="init(@JsonSedeshu.SerializeObject(Model))">
    <partial name="_Loading_Partial" />
    <div ng-cloak>
        <div class="card border-cards">
            <div class="card-header bg-cards text-white">
                <h5>Listado de productividad de los trabajadores</h5>
            </div>
            <div class="card-body">
                <div class="d-flex flex-wrap">
                    <div class="col-3">
                        <label class="required">Dependencias</label>
                        <select class="selectpicker2 form-control" ng-model="DependenciaId" 
                                data-live-search="true" data-title="Seleccione">
                            <option ng-repeat="dependencia in dependencias" 
                                    ng-value="dependencia.Id">{{dependencia.Nombre}}</option>
                        </select>
                        <span class="text-danger small">
                            {{ errors["DependenciaId"] }}
                        </span>
                    </div>
                    @* <div class="col-3">
                        <label>Municipios</label>
                        <select class="selectpicker2 form-control" ng-model="MunicipiosId" multiple
                                ng-change="seleccionarMunicipios()" data-live-search="true" data-title="Seleccione">
                            <option ng-repeat="Municipio in municipios" 
                                    ng-value="Municipio.Id">{{Municipio.Nombre}}</option>
                        </select>
                    </div>
                    <div class="col-3">
                        <label>Localidades</label>
                        <select class="selectpicker2 form-control" ng-model="LocalidadesId" multiple
                                ng-change="seleccionarLocalidades()" data-live-search="true" data-title="Seleccione" 
                                ng-disabled="locGrupos == '' || locGrupos.length <= 0">
                            <optgroup ng-repeat="(municipio, localidades) in locGrupos" label="{{municipio}}">
                                <option ng-repeat="localidad in localidades" ng-value="localidad.Id">
                                    {{localidad.Nombre}}
                                </option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="col-3">
                        <label>Agebs</label>
                        <select class="selectpicker2 form-control" ng-model="AgebsId" multiple
                                data-live-search="true" data-title="Seleccione" 
                                ng-disabled="agGrupos == '' || agGrupos.length <= 0">
                            <optgroup ng-repeat="(localidad, agebs) in agGrupos" label="{{localidad}}">
                                <option ng-repeat="ageb in agebs" ng-value="ageb.Id">
                                    {{ageb.Clave}}
                                </option>
                            </optgroup>
                        </select>
                    </div> *@
                    <div class="col-5">
                        <label class="required">Período</label>
                        <br>
                        <div class="d-flex">
                            <input type="date" ng-model="Inicio" placeholder="yyyy-MM-dd" class="form-control filtro" required/>
                            <span class="text-danger small">
                                {{ errors["Inicio"] }}
                            </span>
                            <span class="al filtro">a</span>
                            <input type="date" ng-model="Fin" placeholder="yyyy-MM-dd" class="form-control filtro" required/>
                            <span class="text-danger small">
                                {{ errors["Fin"] }}
                            </span>
                        </div>
                    </div>
                    <div class="col-2">
                        <br>
                        <button class="mt-2 btn btn-info" ng-click="cargarProductividad()" ng-if="!loading" 
                                ng-disabled="loading || DependenciaId == '' || Inicio == '' || Fin == ''">
                            <i class="fa fa-search"></i> Buscar
                        </button>
                        <button class="mt-2 btn btn-info" ng-if="loading">
                            <i class="fa fa-spinner fa-spin"></i> Buscar
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="card border-cards">
            <div class="card-body">
                <table class="table table-bordered">
                    <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Usuario</th>                        
                        <th>Total</th>
                        <th>Completas</th>
                        <th>Incompletas</th>
                        <th>Tiempo promedio</th>
                        @* <th>Dias de retraso</th> *@
                    </tr>
                    </thead>
                    <tbody ng-repeat="trabajador in trabajadores">
                    <tr ng-click="clickTrabajadorRow(trabajador)" class="cursor-pointer">
                        <td>{{trabajador.Nombre}}</td>
                        <td>{{trabajador.Username}}</td>                        
                        <td>{{trabajador.Total}}</td>
                        <td>{{trabajador.Completas}}</td>
                        <td>{{trabajador.Incompletas}}</td>
                        <td>{{formatoTiempo(trabajador.Promedio)}}</td>
                        @* <td>{{trabajador.DiasRetraso}}</td> *@
                    </tr>
                    <tr ng-if="trabajador.IsOpened && trabajador.Aplicaciones.length > 0" class="table-active">
                        <th>Beneficiario</th>
                        <th>Municipio</th>
                        <th>Localidad</th>
                        <th>Ageb</th>
                        <th>Estatus</th>
                        <th>Fecha inicio</th>
                        <th>Días de retraso</th>
                    </tr>
                    <tr ng-if="trabajador.IsOpened && trabajador.Aplicaciones.length > 0" 
                        ng-repeat="aplicacion in trabajador.Aplicaciones" class="table-active">
                        <td>{{aplicacion.BeneficiarioNombre}}</td>
                        <td>{{aplicacion.MunicipioNombre}}</td>
                        <td>{{aplicacion.LocalidadNombre}}</td>
                        <td>{{aplicacion.AgebClave}}</td>
                        <td>{{aplicacion.Resultado != null ? 
                            (aplicacion.Estatus + "/" + aplicacion.Resultado) : aplicacion.Estatus}}</td>
                        <td>{{aplicacion.FechaInicio}}</td>
                        <td>{{aplicacion.DiasRetraso}}</td>
                    </tr>
                    <tr ng-if="trabajador.IsOpened && trabajador.Aplicaciones.length <= 0" class="table-active">
                        <td colspan="6">Sin datos para mostrar.</td>
                    </tr>
                    </tbody>
                    <tbody>
                    <tr>
                        <th>Total</th>
                        <th colspan="6">{{ totalcount }} trabajadores en la dependencia</th>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="row mb-3">
            <div class="col-12 text-right" ng-if="chartBuilt">
                <label>Cantidad de datos a mostrar</label>
                <select ng-model="dataLimit" ng-change="buildChart()">
                    <option value="5">5</option>
                    <option value="10">10</option>
                    <option value="20">20</option>
                </select>
            </div>
            <div id="columnchart_material" class="col-12"></div>
        </div>
    </div>
</div>

@section Scripts{
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script>
        (() => {
            var app = angular.module('SedeshuApp', ['ui.bootstrap']);
            var baseUrl = document.baseURI;

            app.controller('indexController',
                ($scope, $http, $uibModal) => {
                    $scope.maxsize = 5;
                    $scope.totalcount = 0;
                    $scope.granTotal = 0;
                    $scope.pageIndex = 1;
                    $scope.pageSize = 10;
                    $scope.numPages = 0;
                    $scope.loading = false;
                    
                    $scope.trabajadores = [];
                    $scope.dependencias = [];
                    $scope.municipios = [];
                    $scope.locGrupos = [];
                    $scope.agGrupos = [];
                    
                    $scope.DependenciaId = '';
                    $scope.MunicipiosId = [];
                    $scope.LocalidadesId = [];
                    $scope.AgebsId = [];                    
                    $scope.Inicio = "";
                    $scope.Fin = "";
                    
                    $scope.dataLimit = "5";
                    $scope.chartBuilt = false;

                    $scope.init = model => {
                        $scope.Inicio = new Date(model.Inicio.substring(0, 4), parseInt(model.Inicio.substring(5, 7)) - 1, model.Inicio.substring(8, 10));
                        $scope.Fin = new Date(model.Fin.substring(0, 4), parseInt(model.Fin.substring(5, 7)) - 1, model.Fin.substring(8, 10));
                        $scope.dependencias = model.Dependencias;
                        $scope.municipios = model.Municipios;
                        $scope.refreshSelect();
                    };
                    
                    $scope.seleccionarMunicipios = () => {
                        $scope.loading = true;
                        if ($scope.MunicipiosId.length > 0) {
                            $http.get(baseUrl + 'Localidad/ByMunicipios/' + $scope.MunicipiosId.join()).then(response => {
                                let localidades = response.data;
                                if (localidades != null) {
                                    $scope.locGrupos = localidades;
                                }
                                $scope.refreshSelect();
                                $scope.loading = false;
                            });
                        } else {
                            $scope.locGrupos = [];
                            $scope.LocalidadesId = [];
                            $scope.refreshSelect();
                            $scope.loading = false;
                        }
                    };
                    
                    $scope.seleccionarLocalidades = () => {
                        $scope.loading = true;
                        if ($scope.LocalidadesId.length > 0) {
                            $http.get(baseUrl + 'Ageb/ByLocalidades/' + $scope.LocalidadesId.join()).then(response => {
                                let agebs = response.data;
                                if (agebs != null) {
                                    $scope.agGrupos = agebs;
                                }
                                $scope.refreshSelect();
                                $scope.loading = false;
                            });
                        } else {
                            $scope.agGrupos = [];
                            $scope.AgebsId = [];
                            $scope.refreshSelect();
                            $scope.loading = false;
                        }
                    };
                    
                    $scope.cargarProductividad = () => {
                        if ($scope.DependenciaId != '' && $scope.Inicio != '' && $scope.Fin != '') {
                            $scope.loading = true;
                            $http.post(baseUrl + 'Diagnosticos/GetProductividad', {
                                DependenciaId: $scope.DependenciaId,
                                MunicipiosId: $scope.MunicipiosId.join() != "" ? $scope.MunicipiosId.join() : null,
                                LocalidadesId: $scope.LocalidadesId.join() != "" ? $scope.LocalidadesId.join() : null,
                                AgebsId: $scope.AgebsId.join() != "" ? $scope.AgebsId.join() : null,
                                Inicio: $scope.Inicio,
                                Fin: $scope.Fin,
                            }).then(response => {
                                $scope.trabajadores = response.data.Trabajadores;
                                $scope.totalcount = response.data.Total;
                                
                                $scope.buildChart();
                                
                                $scope.loading = false;
                            });
                        }
                    };
                    
                    $scope.buildChart = () => {
                        google.charts.load("current", { packages: ["corechart"] });
                        const drawChart = () => {
                            let trabajadoresData = [
                                ['Trabajador', 'Total', 'Completas', 'Incompletas'],
                                // ['JOSE', 5, 3, 2],
                            ];
                            if ($scope.trabajadores.length > 0) {
                                _.each($scope.trabajadores, (tr, index) => {
                                    if (index < $scope.dataLimit) {
                                        trabajadoresData.push([
                                            tr.Nombre, parseInt(tr.Total), 
                                            parseInt(tr.Completas), parseInt(tr.Incompletas)
                                        ]);
                                    }
                                });
                            } else {
                                trabajadoresData.push(["", 0, 0, 0]);
                            }
                            let data = google.visualization.arrayToDataTable(trabajadoresData);
                            
                            let view = new google.visualization.DataView(data);

                            let options = {
                                title: "Total de aplicaciones por trabajador",
                                width: "100%",
                                height: 400,
                                bar: {groupWidth: "25%"},
                                legend: { position: "none" },
                            };
                            
                            let chart = new google.visualization.ColumnChart(document.getElementById("columnchart_material"));
                            chart.draw(view, options);
                        };
                        google.charts.setOnLoadCallback(drawChart);
                        $scope.chartBuilt = true;
                    };
                    
                    $scope.clickTrabajadorRow = trabajador => {
                        trabajador.IsOpened = !trabajador.IsOpened
                    };
                    
                    $scope.formatoTiempo = valor => {
                        if (valor != "") {
                            let stringReturn = "";
                            let arrTiempos = valor.split(":");
                            let arrHora = arrTiempos[0].split(".");
                            if (arrHora.length > 1) {
                                stringReturn += arrHora[0] + " d " + arrHora[1] + " h ";
                            } else {
                                stringReturn += arrHora[0] + " h ";
                            }
                            stringReturn += arrTiempos[1] + " m ";
                            let arrSegundos = arrTiempos[2].split(".");
                            stringReturn += arrSegundos[0] + " s.";
                            return  stringReturn;
                        } else {
                            return "Sin datos.";
                        }
                    };
                    
                    $scope.refreshSelect = _.debounce(() => {
                        $('.selectpicker2').selectpicker('refresh');
                    }, 100);
                }
            );
        })();
    </script>
}

@section Styles
{
    <style>
        .cursor-pointer {
            cursor: pointer;
        }
        
        .col-4, .col-12 {
            margin-bottom: 10px;
        }   
        
        .bootstrap-select .dropdown-menu{           
            max-width: 250px !important;
        }
    </style>
}