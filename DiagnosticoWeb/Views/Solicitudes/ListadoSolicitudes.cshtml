@using DiagnosticoWeb.Code
@using System.Security.Claims
@{
    ViewData["Title"] = "Solicitudes";
}

<div ng-app="SedeshuApp" ng-controller="indexController" ng-init="init(@JsonSedeshu.SerializeObject(Model))">
    <partial name="_Loading_Partial" />
    <div ng-cloak>
        <div class="card border-cards">
            <div class="card-header bg-cards text-white">
                <h5>Solicitudes</h5>
            </div>
            <div class="card-body">
                <div class="d-flex flex-wrap">
                    <div class="col-4">
                        <label>Campos</label>
                        <select multiple class="selectpicker2 form-control" ng-change="seleccionarFiltro()" 
                                data-live-search="true" ng-model="selected" data-title="Campos">
                            <optgroup ng-repeat="(index, filtro) in filtros" label="{{index}}">
                                <option ng-repeat="valor in filtro" ng-value="valor.Key">{{corregirFiltro(valor.Key)}}</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="col-4">
                        <label>Período</label>
                        <br>
                        <div class="d-flex">
                            <input type="date" ng-model="Inicio" placeholder="yyyy-MM-dd" class="form-control filtro" />
                            <span class="al filtro">Al</span>
                            <input type="date" ng-model="Fin" placeholder="yyyy-MM-dd" class="form-control filtro" />
                        </div>
                    </div>
                    <div class="col-4" ng-repeat="(icatalogo, catalogo) in catalogos" ng-if="catalogo.Mostrar">
                        <label>{{corregirFiltro(icatalogo)}}</label>
                        <select class="selectpicker2 form-control" ng-if="catalogo.Multiple" ng-model="valores[icatalogo]" ng-change="seleccionarValor(icatalogo)"
                                data-live-search="true" data-title="Seleccione">
                            <option ng-repeat="valor in catalogo.Items" ng-value="valor.Id">{{valor.Nombre}}</option>
                        </select>
                        <input class="form-control" ng-if="!catalogo.Multiple" ng-model="valores[icatalogo]" ng-keyup="$event.keyCode == 13 ? cargarSolicitudes() : null">
                    </div>
                    <div class="col-12">
                        <button class="btn btn-info" ng-click="cargarSolicitudes()" ng-if="!loading">
                            <i class="fa fa-search"></i> Buscar
                        </button>
                        @if (((ClaimsIdentity)User.Identity).HasClaim("Permiso", "solicitudes.exportar"))
                        {
                            <button class="btn btn-info" ng-click="exportarSolicitudes()" ng-if="!loading">
                                <i class="fa fa-file-excel"></i> Exportar
                            </button>
                        }
                        <button class="btn btn btn-info" ng-if="loading">
                            <i class="fa fa-spinner fa-spin"></i> Buscar
                        </button>
                        <form id="form" asp-controller="Solicitudes" asp-action="exportarExcel" method="post" target="_blank">
                            <input id="PageIndex" name="PageIndex" type="hidden">
                            <input id="PageSize" name="PageSize" type="hidden">
                            <input id="Valores" name="Valores" type="hidden">
                            <input id="Inicio" name="Inicio" type="hidden">
                            <input id="Fin" name="Fin" type="hidden">
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <div class="card border-cards">
            <div class="card-body">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Beneficiario</th>
                            <th>Programa social</th>
                            <th>Vertientes</th>
                            <th>Estatus</th>
                            <th>Fecha de creación</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr ng-repeat="solicitud in solicitudes">
                            <td>{{ solicitud.Beneficiario }}</td>
                            <td>{{ solicitud.ProgramaSocial }}</td>
                            <td>{{ solicitud.Vertiente }}</td>
                            <td>
                                <span class="badge badge-warning" ng-if="solicitud.Estatus == 'Pendiente'">{{ solicitud.Estatus }}</span>
                                <span class="badge badge-success" ng-if="solicitud.Estatus == 'Aceptado'">{{ solicitud.Estatus }}</span>
                                <span class="badge badge-danger" ng-if="solicitud.Estatus == 'Rechazado'">{{ solicitud.Estatus }}</span>
                                <span class="badge badge-info" ng-if="solicitud.Estatus == 'Entregado'">{{ solicitud.Estatus }}</span>
                            </td>
                            <td>{{ solicitud.CreatedAt | date:'dd/MM/yyyy' }}</td>
                            <td>
                                <a class="btn btn-sm btn-info" href="@Url.Action(controller: "Solicitudes", action: "VerSolicitud")/{{ solicitud.SolicitudId }}">
                                    <i class="fa fa-eye"></i> Ver
                                </a>
                            </td>
                        </tr>
                        <tr ng-if="solicitudes.length == 0">
                            <td colspan="6">No hay datos para mostrar.</td>
                        </tr>
                    </tbody>
                </table>
                <div class="d-flex justify-content-between">
                    <div>
                        {{totalcount}} de  {{granTotal}} solicitudes
                    </div>
                    <div>
                        <ul uib-pagination total-items="totalcount" ng-change="pagechanged()"
                            items-per-page="pageSize" direction-links="false" ng-model="pageIndex" role="menu"
                            max-size="maxsize" class="pagination-sm" boundary-links="true" rotate="true"
                            num-pages="numPages" style="margin-bottom: 0px !important"></ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts{
    <script>
        (function () {
            var app = angular.module('SedeshuApp', ['ui.bootstrap']);
            var baseUrl = document.baseURI;

            app.controller('indexController',
                function ($scope, $http, $uibModal) {

                    $scope.selected = [];
                    $scope.maxsize = 5;
                    $scope.totalcount = 0;
                    $scope.granTotal = 0;
                    $scope.pageIndex = 1;
                    $scope.pageSize = 10;
                    $scope.numPages = 0;
                    $scope.solicitudes = [];
                    $scope.Inicio = '';
                    $scope.Fin = '';
                    $scope.loading = false;
                    $scope.filtros = {};
                    $scope.catalogos = {};
                    $scope.valores = {};

                    $scope.init = function (model) {
                        $scope.Inicio = new Date(model.Inicio.substring(0, 4), parseInt(model.Inicio.substring(5, 7)) - 1, model.Inicio.substring(8, 10));
                        $scope.Fin = new Date(model.Fin.substring(0, 4), parseInt(model.Fin.substring(5, 7)) - 1, model.Fin.substring(8, 10));
                        $scope.cargarSolicitudes();
                        $scope.cargarFiltros();
                    };

                    $scope.corregirFiltro = function (filtro) {
                        return _.startCase(filtro == 'ApellidoPaterno' ? 'PrimerApellido' : (filtro == 'ApellidoMaterno' ? 'SegundoApellido' : filtro));
                    };

                    $scope.cargarFiltros = function () {
                        axios.get(baseUrl + 'Solicitudes/BuildFiltros').then(function (response) {
                            $scope.filtros = response.data.Filtros;
                            _.each(response.data.Filtros, function (categoria) {
                                _.each(categoria, function (filtro) {
                                    $scope.catalogos[filtro.Key.replace(/ /g, "")] = { Items: [], Mostrar: false, Multiple: filtro.Value };
                                    $scope.valores[filtro.Key.replace(/ /g, "")] = null;
                                })
                            });

                            setTimeout(function () {
                                $scope.$apply(function () {
                                    $scope.refreshSelect();
                                });

                            })
                        });
                    }

                    $scope.cargarCatalogo = function (catalogo) {
                        let municipioId = ($scope.valores.Municipio == null || $scope.valores.Municipio == '') ? '0' : $scope.valores.Municipio;
                        let cat = $scope.catalogos[catalogo.replace(/ /g, "")];
                        if (cat.Multiple) {
                            if (cat.Items.length == 0 || catalogo == 'Localidad' || catalogo == 'Ageb') {
                                axios.get(baseUrl + 'Solicitudes/BuildCatalogos/' + catalogo.split(".-")[0] + '/' + municipioId).then(function (response) {
                                    setTimeout(function () {
                                        $scope.$apply(function () {
                                            cat.Items = response.data;
                                            $scope.refreshSelect();
                                        });
                                    });
                                });
                            } else {
                                setTimeout(function () {
                                    $scope.$apply(function () {
                                        $scope.refreshSelect();
                                    });
                                });
                            }
                        }
                        cat.Mostrar = true;                        
                    };

                    $scope.seleccionarFiltro = function () {
                        _.each($scope.filtros, function (filtro, index) {
                            _.each(filtro, function (f) {
                                if (_.find($scope.selected, function (selected) {
                                    return selected == f.Key;
                                }) == null) {
                                    $scope.catalogos[f.Key.replace(/ /g, "")].Mostrar = false;
                                    $scope.valores[f.Key.replace(/ /g, "")] = "";
                                }
                            });
                        });                        
                        _.each($scope.selected, function (selected) {
                            $scope.cargarCatalogo(selected);
                        })
                    }

                    $scope.seleccionarValor = function (catalogo) {
                        if (catalogo == 'Municipio') {
                            if ($scope.catalogos.Localidad.Mostrar) {
                                $scope.cargarCatalogo('Localidad');
                            }
                            if ($scope.catalogos.Ageb.Mostrar) {
                                $scope.cargarCatalogo('Ageb');
                            }
                        }
                    }

                    $scope.cargarSolicitudes = function () {
                        $scope.loading = true;
                        $http.post(baseUrl + 'Solicitudes/ObtenerSolicitudes', {
                            PageIndex: $scope.pageIndex,
                            PageSize: $scope.pageSize,
                            Inicio: $scope.Inicio,
                            Fin: $scope.Fin,
                            Valores: JSON.stringify($scope.valores)
                        }).then(function (response) {
                            $scope.solicitudes = response.data.Solicitudes;
                            $scope.totalcount = response.data.Total;
                            $scope.granTotal = response.data.GranTotal;
                            $scope.loading = false;
                        });
                    };

                    $scope.pagechanged = function () {
                        $scope.cargarSolicitudes();
                    };

                    $scope.exportarSolicitudes = function () {
                        document.getElementById("PageIndex").value = 0;
                        document.getElementById("PageSize").value = 0;
                        document.getElementById("Inicio").value = $scope.Inicio.toISOString().substring(0, 10);
                        document.getElementById("Fin").value = $scope.Fin.toISOString().substring(0, 10);
                        document.getElementById("Valores").value = JSON.stringify($scope.valores);
                        document.getElementById("form").submit();
                    }

                    $scope.refreshSelect = _.debounce(function () {
                        $('.selectpicker2').selectpicker('refresh');
                    }, 200);
                }
            );
        })();
    </script>
}

@section Styles
    {
    <style>
        .col-4, .col-12 {
            margin-bottom: 10px;
        }   
        
        .bootstrap-select .dropdown-menu{           
            max-width: 250px !important;
        }
    </style>
}
